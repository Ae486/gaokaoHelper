<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIè¿æ¥æµ‹è¯• - é«˜è€ƒå¿—æ„¿å¡«æŠ¥åŠ©æ‰‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .test-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 800px;
            width: 90%;
        }

        .test-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .test-header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .test-header p {
            color: #666;
            font-size: 16px;
        }

        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #f0f0f0;
            border-radius: 10px;
        }

        .test-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .test-button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .result-area {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .result-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .result-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .result-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-pending { background: #ffc107; }

        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <a href="main.html" class="back-button">â† è¿”å›ä¸»é¡µ</a>
    
    <div class="test-container">
        <div class="test-header">
            <h1>ğŸ¤– AIè¿æ¥æµ‹è¯•å·¥å…·</h1>
            <p>æµ‹è¯•DeepSeek APIè¿æ¥çŠ¶æ€å’ŒMBTIæŠ¥å‘Šç”ŸæˆåŠŸèƒ½</p>
        </div>

        <!-- åŸºç¡€è¿æ¥æµ‹è¯• -->
        <div class="test-section">
            <h3><span class="status-indicator status-pending" id="basic-status"></span>åŸºç¡€è¿æ¥æµ‹è¯•</h3>
            <p>å‘é€ç®€å•è¯·æ±‚æµ‹è¯•AIæœåŠ¡æ˜¯å¦å¯ç”¨</p>
            <button class="test-button" onclick="testBasicConnection()" id="basic-btn">
                å¼€å§‹åŸºç¡€æµ‹è¯•
            </button>
            <div id="basic-result" class="result-area" style="display: none;"></div>
        </div>

        <!-- ç®€åŒ–MBTIæŠ¥å‘Šæµ‹è¯• -->
        <div class="test-section">
            <h3><span class="status-indicator status-pending" id="mbti-status"></span>ç®€åŒ–MBTIæŠ¥å‘Šæµ‹è¯•</h3>
            <p>æµ‹è¯•ç”Ÿæˆç®€çŸ­çš„MBTIåˆ†ææŠ¥å‘Š</p>
            <button class="test-button" onclick="testSimpleMbtiReport()" id="mbti-btn">
                æµ‹è¯•MBTIæŠ¥å‘Š
            </button>
            <div id="mbti-result" class="result-area" style="display: none;"></div>
        </div>

        <!-- å®Œæ•´æŠ¥å‘Šæµ‹è¯• -->
        <div class="test-section">
            <h3><span class="status-indicator status-pending" id="full-status"></span>å®Œæ•´æŠ¥å‘Šæµ‹è¯•</h3>
            <p>æµ‹è¯•ç”Ÿæˆå®Œæ•´çš„è¯¦ç»†æŠ¥å‘Šï¼ˆå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼‰</p>
            <button class="test-button" onclick="testFullReport()" id="full-btn">
                æµ‹è¯•å®Œæ•´æŠ¥å‘Šï¼ˆåŸç‰ˆï¼‰
            </button>
            <button class="test-button" onclick="testFullReportWithExtendedTimeout()" id="extended-btn">
                æµ‹è¯•å®Œæ•´æŠ¥å‘Šï¼ˆå»¶é•¿è¶…æ—¶ï¼‰
            </button>
            <div id="full-result" class="result-area" style="display: none;"></div>
        </div>

        <!-- æ‰¹é‡æµ‹è¯• -->
        <div class="test-section">
            <h3>æ‰¹é‡æµ‹è¯•</h3>
            <p>ä¾æ¬¡æ‰§è¡Œæ‰€æœ‰æµ‹è¯•é¡¹ç›®</p>
            <button class="test-button" onclick="runAllTests()" id="all-btn">
                è¿è¡Œæ‰€æœ‰æµ‹è¯•
            </button>
        </div>
    </div>

    <script>
        // è·å–JWTä»¤ç‰Œ
        function getAuthToken() {
            return localStorage.getItem('token') || sessionStorage.getItem('token');
        }

        // é€šç”¨APIè¯·æ±‚å‡½æ•°
        async function apiRequest(url, method = 'POST', data = null) {
            const token = getAuthToken();
            if (!token) {
                throw new Error('æœªæ‰¾åˆ°è®¤è¯ä»¤ç‰Œï¼Œè¯·å…ˆç™»å½•');
            }

            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            };

            if (data) {
                options.body = JSON.stringify(data);
            }

            const response = await fetch(url, options);
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${result.message || 'è¯·æ±‚å¤±è´¥'}`);
            }
            
            return result;
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(elementId, statusId, success, message, data = null) {
            const resultElement = document.getElementById(elementId);
            const statusElement = document.getElementById(statusId);
            
            resultElement.style.display = 'block';
            resultElement.className = `result-area ${success ? 'result-success' : 'result-error'}`;
            
            let content = `æ—¶é—´: ${new Date().toLocaleString()}\n`;
            content += `çŠ¶æ€: ${success ? 'æˆåŠŸ' : 'å¤±è´¥'}\n`;
            content += `æ¶ˆæ¯: ${message}\n`;
            
            if (data) {
                content += `\nå“åº”æ•°æ®:\n${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}`;
            }
            
            resultElement.textContent = content;
            
            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            statusElement.className = `status-indicator ${success ? 'status-success' : 'status-error'}`;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading(buttonId, text = 'æµ‹è¯•ä¸­...') {
            const button = document.getElementById(buttonId);
            button.disabled = true;
            button.innerHTML = `<span class="loading"></span>${text}`;
        }

        // æ¢å¤æŒ‰é’®çŠ¶æ€
        function resetButton(buttonId, text) {
            const button = document.getElementById(buttonId);
            button.disabled = false;
            button.innerHTML = text;
        }

        // åŸºç¡€è¿æ¥æµ‹è¯•
        async function testBasicConnection() {
            showLoading('basic-btn');
            
            try {
                console.log('å¼€å§‹åŸºç¡€è¿æ¥æµ‹è¯•...');
                const result = await apiRequest('/api/personality-test/test-ai-connection');
                
                console.log('åŸºç¡€è¿æ¥æµ‹è¯•æˆåŠŸ:', result);
                showResult('basic-result', 'basic-status', true, result.message, result.data);
                
            } catch (error) {
                console.error('åŸºç¡€è¿æ¥æµ‹è¯•å¤±è´¥:', error);
                showResult('basic-result', 'basic-status', false, error.message);
            } finally {
                resetButton('basic-btn', 'å¼€å§‹åŸºç¡€æµ‹è¯•');
            }
        }

        // ç®€åŒ–MBTIæŠ¥å‘Šæµ‹è¯•
        async function testSimpleMbtiReport() {
            showLoading('mbti-btn');
            
            try {
                console.log('å¼€å§‹ç®€åŒ–MBTIæŠ¥å‘Šæµ‹è¯•...');
                const result = await apiRequest('/api/personality-test/test-simple-mbti-report');
                
                console.log('ç®€åŒ–MBTIæŠ¥å‘Šæµ‹è¯•æˆåŠŸ:', result);
                showResult('mbti-result', 'mbti-status', true, result.message, result.data);
                
            } catch (error) {
                console.error('ç®€åŒ–MBTIæŠ¥å‘Šæµ‹è¯•å¤±è´¥:', error);
                showResult('mbti-result', 'mbti-status', false, error.message);
            } finally {
                resetButton('mbti-btn', 'æµ‹è¯•MBTIæŠ¥å‘Š');
            }
        }

        // å®Œæ•´æŠ¥å‘Šæµ‹è¯•ï¼ˆåŸç‰ˆï¼‰
        async function testFullReport() {
            showLoading('full-btn', 'ç”Ÿæˆä¸­...(å¯èƒ½éœ€è¦1-2åˆ†é’Ÿ)');

            try {
                console.log('å¼€å§‹å®Œæ•´æŠ¥å‘Šæµ‹è¯•ï¼ˆåŸç‰ˆï¼‰...');

                // æ„é€ æµ‹è¯•æ•°æ®
                const testData = {
                    testType: "MBTI",
                    testResult: "INTJ",
                    typeName: "å»ºç­‘å¸ˆ",
                    typeDescription: "INTJç±»å‹çš„äººæ˜¯å®Œç¾ä¸»ä¹‰è€…ã€‚ä»–ä»¬å¼ºçƒˆåœ°è¦æ±‚ä¸ªäººè‡ªç”±å’Œèƒ½åŠ›ï¼ŒåŒæ—¶åœ¨ä»–ä»¬ç‹¬åˆ›çš„æ€æƒ³ä¸­ï¼Œä¸å¯åŠ¨æ‘‡çš„ä¿¡ä»°é©±åŠ¨ç€ä»–ä»¬è¾¾åˆ°ç›®æ ‡ã€‚",
                    dimensionScores: {
                        "EI": 25,
                        "SN": 75,
                        "TF": 80,
                        "JP": 70
                    },
                    recommendedMajors: [
                        {
                            majorName: "è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯",
                            matchScore: 0.95
                        },
                        {
                            majorName: "è½¯ä»¶å·¥ç¨‹",
                            matchScore: 0.90
                        }
                    ]
                };

                const result = await apiRequest('/api/personality-test/detailed-report', 'POST', testData);

                console.log('å®Œæ•´æŠ¥å‘Šæµ‹è¯•æˆåŠŸï¼ˆåŸç‰ˆï¼‰:', result);
                showResult('full-result', 'full-status', true, result.message, result.data);

            } catch (error) {
                console.error('å®Œæ•´æŠ¥å‘Šæµ‹è¯•å¤±è´¥ï¼ˆåŸç‰ˆï¼‰:', error);
                showResult('full-result', 'full-status', false, error.message);
            } finally {
                resetButton('full-btn', 'æµ‹è¯•å®Œæ•´æŠ¥å‘Šï¼ˆåŸç‰ˆï¼‰');
            }
        }

        // å®Œæ•´æŠ¥å‘Šæµ‹è¯•ï¼ˆå»¶é•¿è¶…æ—¶ç‰ˆæœ¬ï¼‰
        async function testFullReportWithExtendedTimeout() {
            showLoading('extended-btn', 'ç”Ÿæˆä¸­...(å»¶é•¿è¶…æ—¶ï¼Œå¯èƒ½éœ€è¦2-3åˆ†é’Ÿ)');

            try {
                console.log('å¼€å§‹å®Œæ•´æŠ¥å‘Šæµ‹è¯•ï¼ˆå»¶é•¿è¶…æ—¶ç‰ˆæœ¬ï¼‰...');

                const result = await apiRequest('/api/personality-test/test-full-report-with-extended-timeout');

                console.log('å®Œæ•´æŠ¥å‘Šæµ‹è¯•æˆåŠŸï¼ˆå»¶é•¿è¶…æ—¶ç‰ˆæœ¬ï¼‰:', result);
                showResult('full-result', 'full-status', true, result.message, result.data);

            } catch (error) {
                console.error('å®Œæ•´æŠ¥å‘Šæµ‹è¯•å¤±è´¥ï¼ˆå»¶é•¿è¶…æ—¶ç‰ˆæœ¬ï¼‰:', error);
                showResult('full-result', 'full-status', false, error.message);
            } finally {
                resetButton('extended-btn', 'æµ‹è¯•å®Œæ•´æŠ¥å‘Šï¼ˆå»¶é•¿è¶…æ—¶ï¼‰');
            }
        }

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            const allButton = document.getElementById('all-btn');
            allButton.disabled = true;
            allButton.innerHTML = '<span class="loading"></span>è¿è¡Œä¸­...';
            
            try {
                console.log('å¼€å§‹æ‰¹é‡æµ‹è¯•...');
                
                // ä¾æ¬¡æ‰§è¡Œæµ‹è¯•
                await testBasicConnection();
                await new Promise(resolve => setTimeout(resolve, 2000)); // ç­‰å¾…2ç§’
                
                await testSimpleMbtiReport();
                await new Promise(resolve => setTimeout(resolve, 2000)); // ç­‰å¾…2ç§’
                
                await testFullReport();
                
                console.log('æ‰€æœ‰æµ‹è¯•å®Œæˆ');
                
            } catch (error) {
                console.error('æ‰¹é‡æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯:', error);
            } finally {
                allButton.disabled = false;
                allButton.innerHTML = 'è¿è¡Œæ‰€æœ‰æµ‹è¯•';
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        window.onload = function() {
            const token = getAuthToken();
            if (!token) {
                alert('è¯·å…ˆç™»å½•åå†è¿›è¡Œæµ‹è¯•');
                window.location.href = 'index.html';
            }
        };
    </script>
</body>
</html>
