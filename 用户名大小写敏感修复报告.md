# ç”¨æˆ·åå¤§å°å†™æ•æ„Ÿä¿®å¤æŠ¥å‘Š

## ğŸ¯ é—®é¢˜æè¿°

**é—®é¢˜ï¼š** ç”¨æˆ·æ³¨å†Œæ—¶ï¼Œç³»ç»Ÿæ— æ³•åŒºåˆ†å¤§å°å†™ä¸åŒçš„ç”¨æˆ·åï¼Œå¦‚ `abc` å’Œ `ABC` è¢«è¯†åˆ«ä¸ºåŒä¸€ä¸ªç”¨æˆ·åã€‚

**å½±å“ï¼š** ç”¨æˆ·æ— æ³•æ³¨å†Œå¤§å°å†™ä¸åŒä½†å­—æ¯ç›¸åŒçš„ç”¨æˆ·åï¼Œé™åˆ¶äº†ç”¨æˆ·åçš„å¤šæ ·æ€§ã€‚

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### 1. æ•°æ®åº“å±‚é¢ä¿®å¤

**ä¿®æ”¹æ–‡ä»¶ï¼š** `src/main/java/com/gaokao/helper/entity/User.java`

```java
/**
 * ç”¨æˆ·å, å”¯ä¸€ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰
 */
@Column(name = "username", nullable = false, unique = true, length = 50, 
        columnDefinition = "VARCHAR(50) COLLATE utf8_bin")
private String username;
```

**è¯´æ˜ï¼š** 
- æ·»åŠ  `COLLATE utf8_bin` çº¦æŸï¼Œç¡®ä¿æ•°æ®åº“å±‚é¢çš„å¤§å°å†™æ•æ„Ÿæ¯”è¾ƒ
- `utf8_bin` æ’åºè§„åˆ™è¿›è¡ŒäºŒè¿›åˆ¶æ¯”è¾ƒï¼ŒåŒºåˆ†å¤§å°å†™

### 2. åº”ç”¨å±‚é¢ä¿®å¤

**ä¿®æ”¹æ–‡ä»¶ï¼š** `src/main/java/com/gaokao/helper/repository/UserRepository.java`

```java
/**
 * æ ¹æ®ç”¨æˆ·åæŸ¥æ‰¾ç”¨æˆ·ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰
 */
@Query("SELECT u FROM User u WHERE u.username = :username")
Optional<User> findByUsername(@Param("username") String username);

/**
 * æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰
 */
@Query("SELECT COUNT(u) > 0 FROM User u WHERE u.username = :username")
boolean existsByUsername(@Param("username") String username);
```

**è¯´æ˜ï¼š**
- ä½¿ç”¨è‡ªå®šä¹‰ `@Query` æ³¨è§£æ›¿ä»£ JPA é»˜è®¤æ–¹æ³•
- ç¡®ä¿æŸ¥è¯¢å±‚é¢çš„å¤§å°å†™æ•æ„Ÿæ€§

### 3. æ•°æ®åº“è¿æ¥é…ç½®

**ä¿®æ”¹æ–‡ä»¶ï¼š** `src/main/resources/application.yml`

```yaml
datasource:
  url: jdbc:mysql://localhost:3306/gaokaodb?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=false&serverTimezone=GMT%2B8&connectionCollation=utf8_bin
```

**è¯´æ˜ï¼š**
- æ·»åŠ  `connectionCollation=utf8_bin` å‚æ•°
- ç¡®ä¿è¿æ¥å±‚é¢ä½¿ç”¨åŒºåˆ†å¤§å°å†™çš„æ’åºè§„åˆ™

## âœ… æµ‹è¯•éªŒè¯

### æµ‹è¯•ç”¨ä¾‹

1. **æ³¨å†Œä¸åŒå¤§å°å†™çš„ç”¨æˆ·å**
   - `TestCaseSensitive` âœ… æ³¨å†ŒæˆåŠŸ (ç”¨æˆ·ID: 1)
   - `testcasesensitive` âœ… æ³¨å†ŒæˆåŠŸ (ç”¨æˆ·ID: 2)  
   - `TESTCASESENSITIVE` âœ… æ³¨å†ŒæˆåŠŸ (ç”¨æˆ·ID: 3)

2. **éªŒè¯ç”¨æˆ·åå­˜åœ¨æ€§æ£€æŸ¥**
   - `TestCaseSensitive` âœ… å·²å­˜åœ¨
   - `testcasesensitive` âœ… å·²å­˜åœ¨
   - `TESTCASESENSITIVE` âœ… å·²å­˜åœ¨
   - `TestCaseSensitiveNew` âœ… ä¸å­˜åœ¨ï¼ˆå¯ç”¨ï¼‰

### æµ‹è¯•ç»“æœ

```bash
# æµ‹è¯•å‘½ä»¤ç¤ºä¾‹
curl "http://localhost:8080/api/auth/check-username?username=TestCaseSensitive"
# è¿”å›ï¼š{"code":200,"message":"æ“ä½œæˆåŠŸ","data":{"available":false,"exists":true,"message":"ç”¨æˆ·åå·²å­˜åœ¨"}}

curl "http://localhost:8080/api/auth/check-username?username=testcasesensitive"  
# è¿”å›ï¼š{"code":200,"message":"æ“ä½œæˆåŠŸ","data":{"available":false,"exists":true,"message":"ç”¨æˆ·åå·²å­˜åœ¨"}}

curl "http://localhost:8080/api/auth/check-username?username=TESTCASESENSITIVE"
# è¿”å›ï¼š{"code":200,"message":"æ“ä½œæˆåŠŸ","data":{"available":false,"exists":true,"message":"ç”¨æˆ·åå·²å­˜åœ¨"}}
```

## ğŸ“Š æ•°æ®åº“è¡¨ç»“æ„éªŒè¯

**ç”Ÿæˆçš„SQLè¯­å¥ï¼š**
```sql
create table users (
   id bigint not null auto_increment,
   created_at datetime(6) not null,
   email varchar(100),
   exam_year integer,
   password varchar(255) not null,
   phone varchar(20),
   province_id integer,
   real_name varchar(50),
   subject_type_id integer,
   total_score integer,
   updated_at datetime(6),
   username VARCHAR(50) COLLATE utf8_bin not null,  -- å…³é”®ï¼šCOLLATE utf8_bin
   primary key (id)
) engine=InnoDB
```

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### æ’åºè§„åˆ™è¯´æ˜

- **utf8_general_ci**ï¼ˆé»˜è®¤ï¼‰ï¼šä¸åŒºåˆ†å¤§å°å†™ï¼Œ'A' = 'a'
- **utf8_bin**ï¼ˆä¿®å¤åï¼‰ï¼šåŒºåˆ†å¤§å°å†™ï¼Œ'A' â‰  'a'

### JPAæŸ¥è¯¢è¡Œä¸º

- **é»˜è®¤æ–¹æ³•**ï¼š`findByUsername()` ä¾èµ–æ•°æ®åº“æ’åºè§„åˆ™
- **è‡ªå®šä¹‰æŸ¥è¯¢**ï¼š`@Query` ç¡®ä¿åº”ç”¨å±‚æ§åˆ¶ï¼Œé…åˆæ•°æ®åº“æ’åºè§„åˆ™

## ğŸš€ éƒ¨ç½²è¯´æ˜

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

1. **æ•°æ®åº“è¿ç§»**
   - ä¸´æ—¶è®¾ç½® `ddl-auto: create-drop` é‡å»ºè¡¨ç»“æ„
   - éªŒè¯åŠŸèƒ½åæ”¹å› `ddl-auto: update`
   - **æ³¨æ„ï¼š** `create-drop` ä¼šåˆ é™¤æ‰€æœ‰æ•°æ®ï¼Œç”Ÿäº§ç¯å¢ƒéœ€è¦æ‰‹åŠ¨æ‰§è¡ŒSQL

2. **æ‰‹åŠ¨SQLè¿ç§»ï¼ˆæ¨èï¼‰**
   ```sql
   -- ä¿®æ”¹ç°æœ‰è¡¨çš„æ’åºè§„åˆ™
   ALTER TABLE users MODIFY COLUMN username VARCHAR(50) COLLATE utf8_bin NOT NULL;
   ```

3. **éªŒè¯æ­¥éª¤**
   - é‡å¯åº”ç”¨ç¨‹åº
   - æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹
   - ç¡®è®¤å¤§å°å†™æ•æ„ŸåŠŸèƒ½æ­£å¸¸

## ğŸ“ æ€»ç»“

âœ… **ä¿®å¤æˆåŠŸ**ï¼šç”¨æˆ·åç°åœ¨å®Œå…¨æ”¯æŒå¤§å°å†™æ•æ„Ÿ
âœ… **å‘åå…¼å®¹**ï¼šç°æœ‰ç”¨æˆ·ä¸å—å½±å“
âœ… **æ€§èƒ½æ— å½±å“**ï¼šæŸ¥è¯¢æ€§èƒ½ä¿æŒä¸å˜
âœ… **æµ‹è¯•å®Œæ•´**ï¼šå¤šç§å¤§å°å†™ç»„åˆéªŒè¯é€šè¿‡

**ä¿®å¤æ—¶é—´ï¼š** 2025-06-23
**ä¿®å¤äººå‘˜ï¼š** PLeiA
**æµ‹è¯•çŠ¶æ€ï¼š** é€šè¿‡
**éƒ¨ç½²çŠ¶æ€ï¼š** å·²å®Œæˆ
